## 2023/5/31

初步定下来，**一类信息放一个UDP的端口**，避免端口的占用与数据的分离问题。后端现在暂时用着Flask,后面应该可以有支持多线程的高效运行方法。目前想要的信息有`generated_SRS`的原始SRS数据，`received_SRS`的接受信号信息，同时应该可以顺带着把信号的功率、噪声功率给提出来。

需要注意一点的是，VSCode终端打印信息好像会有问题，当信息太多的时候程序会跟不上，这应该是硬件问题限制的，没办法；然后运行的时候最好是直接本地运行而不是远程VSCode运行，笔记本用无线网络连接的时候特比特别的卡，导致效果很差。

相关的代码在`openair1/PHY/NR_ESTIMATION/nr_ul_channel_estimation.c`里面，定位关键词是`SRS_DEBUG`。要用Protobuf进行数据的传输，以之前的代码为例子重新理顺一下吧：

```protobuf
syntax = "proto2";
package protocol;
message NR_SRS_IQ_EST {
  repeated CHANNLE_EST CHANNLE_EST_LIST = 4;
}

message CHANNLE_EST {
  required int32 image = 1;
  required int32 real  = 2;
}
```

在SRS信号传输的那部分，由于传输的数据是一个数组，数组里面的元素每一个都是由实部和虚部组成的。由于事先不知道数组的大小，所以用`repeated`的`CHANNLE_EST`来声明组成一个类似动态数组的结构`CHANNLE_EST_LIST`。注意这里的`CHANNLE_EST`也是一个自定义的`message`,但是里面的内容是确定的`required`。至于为什么CHANNLE_EST_LIST的标识符是4，其实这个没有特别说明，一个`message`里面出现的字段只要满足他们的标识符相互不同且不在某一个特定的范围`[19000－19999]`就行。

下面就可以设计一下我们需要传输的message了：暂时打算有几个内容需要打包传输：

![data-format.png](https://s2.loli.net/2023/05/31/RYMw96rBWjhLf8H.png)

对于上行信道估计的相关逻辑保存在`openair1/PHY/NR_ESTIMATION/nr_ul_channel_estimation.c`文件中，对应的函数是`int nr_srs_channel_estimation()`这个函数。该函数实现的功能有原始的SRS信号数据、接受的SRS信号数据、使用最小二乘的估计数据，接收的SRS信号的功率信息、噪声功率信息以及每个RB的噪声功率信息。定位关键词为`ifdef SRS_DEBUG`。

在这里有原始的SRS数据（`genRe`、`genIm`），接收的SRS数据（`rxRe`、`rxIm`）以及使用最小二乘估计的结果（`lsRe`、`lsIm`）。数据的存放使用的是数组，原始产生的数据用的是`srs_generated_signal`，接收的数据是`srs_received_signal`，最小二乘估计的结果是`ls_estimated`。

原始信号的数据打印和`openair1/SCHED_NR/phy_procedures_nr_gnb.c`中的数据打印方式类似，都是嵌套在多层循环里面，但是后者的打印逻辑是**每个负责SRS的UE端口中的每一个基站天线元的每一个接收符号**进行打印，一共是三层的嵌套。但是如果将SRS_DEBUG的宏定义取消掉即便在终端能打印出信息，但是可能存在一定的时延问题导致没法稳定的打印，但是进行运算是没问题的。


## 2023/6/1

完成了前端可视化部分的代码，代码逻辑应该没什么问题，需要考虑的就只有那个动态更新的功率。使用了一个双向队列`collections.deque`来限定长度，防止内存溢出；效果如图：

![SONY-demo](https://s2.loli.net/2023/06/02/kobU8NFBcuxJgOl.gif)

## 2023/6/2
讨论了一下应该是想用2T2R的配置。今天看看能不能把数据转发的工作完成，能完成就是胜利，然后下周再弄可视化和数据的处理。新提取到的数据长这样：
```log
[NR_PHY]   Calling nr_srs_channel_estimation function
[NR_PHY]   ====================== UE port 0 --> gNB Rx antenna 0 ======================
[NR_PHY]   ------------------------------------ 0 ------------------------------------
[NR_PHY]          __genRe________genIm__|____rxRe_________rxIm__|____lsRe________lsIm_
[NR_PHY]   (   0)    511             0  |    1489         1373  |     743          685
[NR_PHY]   (   2)   -315          -404  |     843        -1895  |     488          915
[NR_PHY]   (   4)    468          -207  |    2528         1489  |     854         1191
[NR_PHY]   (   6)    344          -379  |    1861         1011  |     250         1028
[NR_PHY]   (   8)   -483           170  |   -1049        -2449  |      88         1329
[NR_PHY]   (  10)   -250          -447  |    1813        -2280  |     552         1348
[NR_PHY]   ------------------------------------ 1 ------------------------------------
[NR_PHY]          __genRe________genIm__|____rxRe_________rxIm__|____lsRe________lsIm_
[NR_PHY]   (  12)   -499          -116  |    1188        -2212  |    -329         1212
[NR_PHY]   (  14)    488           153  |   -1559         1802  |    -474         1091
[NR_PHY]   (  16)    142           491  |   -3244          367  |    -274         1606
[NR_PHY]   (  18)    511            20  |    -278         2234  |     -96         1120
[NR_PHY]   (  20)   -490           151  |     687        -1526  |    -554          628
[NR_PHY]   (  22)   -494          -137  |    1669         -193  |    -780          316
[NR_PHY]   ------------------------------------ 2 ------------------------------------
[NR_PHY]          __genRe________genIm__|____rxRe_________rxIm__|____lsRe________lsIm_
[NR_PHY]   (  24)    -90           504  |    -977         -397  |    -110          515
[NR_PHY]   (  26)   -282          -428  |    1830          132  |    -560          728
[NR_PHY]   (  28)   -213          -466  |    2314         1627  |   -1222          714
[NR_PHY]   (  30)   -303           413  |    -422        -2340  |    -819          862
[NR_PHY]   (  32)   -264          -439  |    2314         1532  |   -1254          597
[NR_PHY]   (  34)   -369          -356  |    3139         2308  |   -1934          259
[NR_PHY]   ------------------------------------ 3 ------------------------------------
[NR_PHY]          __genRe________genIm__|____rxRe_________rxIm__|____lsRe________lsIm_
[NR_PHY]   (  36)     81           505  |     -41        -3475  |   -1717         -255
[NR_PHY]   (  38)   -504            90  |    2717         -565  |   -1387           39
[NR_PHY]   (  40)   -335           387  |    3230        -1045  |   -1452         -879
[NR_PHY]   (  42)    413          -302  |   -1921          770  |   -1002         -256
[NR_PHY]   (  44)    447           248  |   -1672        -1681  |   -1137         -329
[NR_PHY]   (  46)    425          -285  |   -1734          236  |    -786         -385

[NR_PHY]   ------------------------------------ 101 ------------------------------------
[NR_PHY]          __genRe________genIm__|____rxRe_________rxIm__|____lsRe________lsIm_
[NR_PHY]   (1212)    -90           504  |    -841         2894  |    1498          159
[NR_PHY]   (1214)   -494          -137  |   -1587         -953  |     893          247
[NR_PHY]   (1216)   -490           151  |   -2040          167  |    1000          220
[NR_PHY]   (1218)    511            20  |    2292          653  |    1156          281
[NR_PHY]   (1220)    142           491  |    -846         1034  |     378          549
[NR_PHY]   (1222)    488           153  |    1596         2602  |    1149         1001
[NR_PHY]   ------------------------------------ 102 ------------------------------------
[NR_PHY]          __genRe________genIm__|____rxRe_________rxIm__|____lsRe________lsIm_
[NR_PHY]   (1224)   -499          -116  |    -938        -1673  |     646          709
[NR_PHY]   (1226)   -250          -447  |     553        -2373  |     900          820
[NR_PHY]   (1228)   -483           170  |   -2181         -986  |     865          827
[NR_PHY]   (1230)    344          -379  |    2194          853  |     421         1098
[NR_PHY]   (1232)    468          -207  |    1208         3464  |    -149         1827
[NR_PHY]   (1234)   -315          -404  |    1565        -2412  |     470         1359
[NR_PHY]   ------------------------------------ 103 ------------------------------------
[NR_PHY]          __genRe________genIm__|____rxRe_________rxIm__|____lsRe________lsIm_
[NR_PHY]   (1236)    511             0  |    -476         3670  |    -238         1831
[NR_PHY]   (1238)    511             0  |    -700         4141  |    -350         2066
[NR_PHY]   (1240)   -315          -404  |    2685        -1770  |    -128         1603
[NR_PHY]   (1242)    468          -207  |     577         2813  |    -305         1402
[NR_PHY]   (1244)    344          -379  |    1472         3282  |    -721         1647
[NR_PHY]   (1246)   -483           170  |     489        -2240  |    -603          975
[NR_PHY]   signal_power = 2845797
[NR_PHY]   noise_power = 19480, SNR = 21 dB
```
相关的配置信息：
```log
[NR_PHY]   ====================== UE port 0 --> gNB Rx antenna 0 ======================
[NR_PHY]   =============== OFDM Symbol Size: 1536 --> srs_pdu->num_symbols: 0 ==============
[NR_PHY]   signal_power = 1432
[NR_PHY]   noise_power = 32, SNR = 16 dB
[NR_PHY]   Calling nr_srs_channel_estimation function
[NR_PHY]   subcarrier_offset: 900 | N_ap: 1 | K_TC: 2 | m_SRS_b: 104 | M_sc_b_SRS 624| fd_cdm : 1 | mem_offset: 0
[NR_PHY]   ====================== UE port 0 --> gNB Rx antenna 0 ======================
[NR_PHY]   =============== OFDM Symbol Size: 1536 --> srs_pdu->num_symbols: 0 ==============
[NR_PHY]   signal_power = 933
[NR_PHY]   noise_power = 50, SNR = 12 dB
```
| OFDM Symbol Size | subcarrier_offset | N_ap | K_TC | m_SRS_b | M_sc_b_SRS | fd_cdm | mem_offset |
| ---------------- | ----------------- | ---- | ---- | ------- | ---------- | ------ | ---------- |
| 1536             | 900               | 1    | 2    | 104     | 624        | 1      | 0          |